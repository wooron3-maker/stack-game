<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Stack Game</title>

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:sans-serif;background:#f5f5f5;margin:0;padding:10px;text-align:center}
h1{margin:8px 0}
#status{font-size:18px;margin:10px 0;font-weight:bold}

.board{
 display:grid;
 grid-template-columns:repeat(3,120px);
 gap:10px;
 justify-content:center;
 margin:12px auto
}

.cell{
 width:120px;
 height:140px;
 background:#fff;
 border:2px solid #444;
 position:relative;
 padding:4px;
}

.cell.win-line{
 background:#fff3a0;
 box-shadow:0 0 10px rgba(255,180,0,.8);
}

.top-area{
 height:80px;
 display:flex;
 align-items:center;
 justify-content:center;
}

.under-area{
 height:40px;
 display:flex;
 justify-content:center;
 gap:6px;
}

.card{
 width:56px;
 height:56px;
 border-radius:8px;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:26px;
 font-weight:bold;
 transition:.15s;
}

.card.small{
 width:36px;
 height:36px;
 font-size:16px;
 opacity:.6;
}

.red{background:#ffcccc;border:2px solid #c00}
.black{background:#ddd;border:2px solid #000}

.selected{
 background:#fff3a0!important;
 border:3px solid orange!important;
 box-shadow:0 0 8px rgba(255,165,0,.8);
}

.hand{
 display:flex;
 justify-content:center;
 gap:8px;
 margin:8px 0
}

.hand span{
 padding:10px 14px;
 border-radius:6px;
 font-weight:bold;
 font-size:18px;
}

.hand.active span{outline:3px solid #7fdfff}
.hand.inactive{opacity:.5}

button{
 margin:6px;
 padding:10px 16px;
 font-size:16px
}

/* ===== 新・演出（UI非干渉） ===== */
.effect-text{
 position:fixed;
 top:50%;
 left:50%;
 transform:translate(-50%,-50%);
 font-size:18vw;              /* 画面を覆うサイズ */
 font-weight:900;
 color:#ff4fa3;               /* ピンク太文字 */
 text-shadow:
  0 0 20px rgba(255,80,160,.6),
  0 0 40px rgba(255,80,160,.5);
 white-space:nowrap;
 pointer-events:none;
 z-index:9999;
 animation:blinkText 3.5s ease-in-out forwards;
}

@keyframes blinkText{
 0%{opacity:0}
 20%{opacity:1}
 40%{opacity:.3}
 60%{opacity:1}
 80%{opacity:.3}
 100%{opacity:0}
}
</style>
</head>

<body>
<h1>Stack Game</h1>
<div id="status"></div>

<div id="hand-black" class="hand"></div>
<div class="board" id="board"></div>
<div id="hand-red" class="hand"></div>

<div>
 <button onclick="undo()">一手前に戻る</button>
 <button onclick="resetGame()">リセット</button>
</div>

<script>
const strength={J:1,Q:2,K:3}
let board,hands,currentPlayer
let selectedHand=null
let selectedCell=null
let history=[]
let gameOver=false
let moveCount=0

function init(){
 board=Array.from({length:9},()=>[])
 hands={red:['K','K','Q','Q','J','J'],black:['K','K','Q','Q','J','J']}
 currentPlayer='red'
 selectedHand=null
 selectedCell=null
 history=[]
 gameOver=false
 moveCount=0
 render()
}

function saveHistory(){
 history.push(JSON.parse(JSON.stringify({board,hands,currentPlayer,moveCount})))
}

function undo(){
 if(!history.length)return
 const p=history.pop()
 board=p.board
 hands=p.hands
 currentPlayer=p.currentPlayer
 moveCount=p.moveCount
 selectedHand=null
 selectedCell=null
 gameOver=false
 render()
}

function resetGame(){init()}

function canStack(target,card){
 if(!target.length)return true
 const top=target[target.length-1]
 return top.color!==card.color && strength[card.rank]>strength[top.rank]
}

function showEffect(text){
 const d=document.createElement('div')
 d.className='effect-text'
 d.textContent=text
 document.body.appendChild(d)
 setTimeout(()=>d.remove(),3600)
}

function checkSexEffect(under,upper){
 if(under==='Q'&&upper==='K')showEffect('正常位')
 if(under==='J'&&upper==='Q')showEffect('騎乗位')
 if(under==='J'&&upper==='K')showEffect('ボーイズラブ')
}

function checkWin(){
 const L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]
 for(const l of L){
  const t=l.map(i=>board[i][board[i].length-1]).filter(Boolean)
  if(t.length===3 && t.every(c=>c.color===t[0].color)){
   return {color:t[0].color,line:l}
  }
 }
 return null
}

function render(){
 const win=checkWin()
 if(win)gameOver=true

 document.getElementById('status').textContent=
  gameOver?(win.color==='red'?'赤':'黒')+'の勝利'
  :(currentPlayer==='red'?'赤':'黒')+'の番'

 const bd=document.getElementById('board')
 bd.innerHTML=''

 for(let i=0;i<9;i++){
  const cell=document.createElement('div')
  cell.className='cell'
  if(win&&win.line.includes(i))cell.classList.add('win-line')
  cell.onclick=()=>cellClick(i)

  const topA=document.createElement('div')
  topA.className='top-area'
  const underA=document.createElement('div')
  underA.className='under-area'

  const st=board[i]
  if(st.length){
   const top=st[st.length-1]
   const d=document.createElement('div')
   d.className='card '+top.color
   if(selectedCell===i)d.classList.add('selected')
   d.textContent=top.rank
   topA.appendChild(d)

   st.slice(0,-1).slice(-2).forEach(c=>{
    const u=document.createElement('div')
    u.className='card small '+c.color
    u.textContent=c.rank
    underA.appendChild(u)
   })
  }

  cell.append(topA,underA)
  bd.appendChild(cell)
 }

 ['red','black'].forEach(color=>{
  const h=document.getElementById('hand-'+color)
  h.innerHTML=''
  h.className='hand '+(currentPlayer===color?'active':'inactive')
  hands[color].forEach((r,idx)=>{
   const s=document.createElement('span')
   s.className=color
   s.textContent=r
   if(selectedHand&&selectedHand.color===color&&selectedHand.index===idx)
    s.classList.add('selected')
   s.onclick=()=>selectHand(color,idx)
   h.appendChild(s)
  })
 })
}

function selectHand(color,idx){
 if(gameOver||color!==currentPlayer)return
 selectedHand={color,index:idx}
 selectedCell=null
 render()
}

function cellClick(i){
 if(gameOver)return
 const st=board[i]
 const top=st[st.length-1]

 if(st.length&&top.color===currentPlayer){
  selectedCell=i
  selectedHand=null
  render()
  return
 }

 if(selectedHand){
  const r=hands[currentPlayer][selectedHand.index]
  const card={rank:r,color:currentPlayer}
  if(!canStack(st,card))return

  if(currentPlayer==='red'&&moveCount===0&&i===4&&r==='K'){
   showEffect('絶倫')
  }
  if(st.length)checkSexEffect(st[st.length-1].rank,r)

  saveHistory()
  st.push(card)
  hands[currentPlayer].splice(selectedHand.index,1)
  selectedHand=null
  currentPlayer=currentPlayer==='red'?'black':'red'
  moveCount++
  render()
  return
 }

 if(selectedCell!==null){
  const mv=board[selectedCell].pop()
  if(!canStack(st,mv)){
   board[selectedCell].push(mv)
   return
  }
  if(st.length)checkSexEffect(st[st.length-1].rank,mv.rank)

  saveHistory()
  st.push(mv)
  selectedCell=null
  currentPlayer=currentPlayer==='red'?'black':'red'
  moveCount++
  render()
 }
}

init()
</script>
</body>
</html>
